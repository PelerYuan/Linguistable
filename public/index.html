<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <title>动态表格示例 - 带拖拽列</title>
  <!-- 引入 Bootstrap CSS -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <!-- 引入 Bootstrap Icons -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css">
  <style>
    th,
    td {
      min-width: 80px;
      text-align: center;
      vertical-align: middle;
    }

    /* 固定拖拽列宽度 */
    .drag-col {
      width: 40px;
    }

    /* 删除按钮所在单元格 */
    .delete-col {
      width: 120px;
    }

    /* 表头和拖拽列样式 */
    thead th,
    tbody td:first-child {
      background-color: #f8f9fa;
      color: #212529;
    }

    /* 拖拽时的占位样式 */
    .sortable-ghost {
      opacity: 0.4;
    }

    .sortable-chosen {
      background-color: #e0e0e0;
    }

    /* 取消鼠标悬停时的颜色变化 */
    .table-hover tbody tr:hover {
      background-color: transparent !important;
    }
  </style>
</head>

<body class="p-4">
  <div class="container">
    <h1 class="mb-4">动态表格示例 - 带拖拽列</h1>
    <!-- 按钮组 -->
    <div class="mb-3">
      <button class="btn btn-primary mr-2" onclick="addRow()">添加行</button>
      <button class="btn btn-success mr-2" onclick="addColumn()">添加列</button>
    </div>
    <!-- 表格：增加拖拽列 -->
    <table id="dynamicTable" class="table table-bordered table-hover">
      <thead>
        <tr>
          <!-- 拖拽列 -->
          <th class="drag-col"></th>
          <!-- 内容列：两个下拉选择框 -->
          <th>
            <select class="form-control">
              <option>选项1</option>
              <option>选项2</option>
              <option>选项3</option>
            </select>
          </th>
          <th>
            <select class="form-control">
              <option>选项A</option>
              <option>选项B</option>
              <option>选项C</option>
            </select>
          </th>
          <!-- 操作列 -->
          <th class="delete-col">操作</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <!-- 拖拽单元格 -->
          <td class="drag-col"><span class="drag-handle" style="cursor: move;">☰</span></td>
          <!-- 内容单元格 -->
          <td contenteditable="true">单元格</td>
          <td contenteditable="true">单元格</td>
          <!-- 删除按钮 -->
          <td class="delete-col">
            <button class="btn btn-danger btn-sm" onclick="deleteThisRow(this)">
              <i class="bi bi-trash"></i>
            </button>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- 引入 SortableJS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
  <script>
    // 初始化 SortableJS，指定拖拽把手为 .drag-handle
    var tbody = document.querySelector("#dynamicTable tbody");
    Sortable.create(tbody, {
      animation: 150,
      ghostClass: 'sortable-ghost',
      chosenClass: 'sortable-chosen',
      handle: '.drag-handle'
    });

    // 添加行：新行包含拖拽单元格、内容单元格（数量 = 表头总单元格数 - 2）和删除单元格
    function addRow() {
      const tableBody = document.querySelector("#dynamicTable tbody");
      const headerRow = document.querySelector("#dynamicTable thead tr");
      // 表头总单元格数包括：拖拽列 + 内容列 + 删除列
      const contentCellsCount = headerRow.cells.length - 2;
      const newRow = tableBody.insertRow(-1);

      // 创建拖拽单元格
      let dragCell = newRow.insertCell(0);
      dragCell.className = "drag-col";
      dragCell.innerHTML = '<span class="drag-handle" style="cursor: move;">☰</span>';

      // 添加内容单元格
      for (let i = 0; i < contentCellsCount; i++) {
        let cell = newRow.insertCell(-1);
        cell.contentEditable = "true";
        cell.innerText = "单元格";
      }

      // 添加删除按钮单元格
      let deleteCell = newRow.insertCell(-1);
      deleteCell.className = "delete-col";
      deleteCell.innerHTML = '<button class="btn btn-danger btn-sm" onclick="deleteThisRow(this)"><i class="bi bi-trash"></i></button>';
    }

    // 添加列：在拖拽列和删除列之间添加新内容列
    function addColumn() {
      const headerRow = document.querySelector("#dynamicTable thead tr");
      // 在最后一个单元格之前插入新列（不改变拖拽列）
      let newHeaderCell = document.createElement("th");
      let select = document.createElement("select");
      select.className = "form-control";
      select.innerHTML = '<option>选项1</option><option>选项2</option><option>选项3</option>';
      newHeaderCell.appendChild(select);
      headerRow.insertBefore(newHeaderCell, headerRow.lastElementChild);

      // 对于表体中的每一行，在删除列前插入新单元格
      const tableBody = document.querySelector("#dynamicTable tbody");
      for (let row of tableBody.rows) {
        let newCell = row.insertCell(row.cells.length - 1);
        newCell.contentEditable = "true";
        newCell.innerText = "单元格";
      }
    }

    // 删除行：删除当前所在的行
    function deleteThisRow(button) {
      const row = button.parentNode.parentNode;
      row.parentNode.removeChild(row);
    }
  </script>
</body>

</html>